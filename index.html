<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>scene-editor</title>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <canvas id="scene"></canvas>
    <div id="ui">
      <div class="ui-topbar ui-panel">
        <div class="ui-topbar-left" role="menubar" aria-label="Top menu">
          <div class="ui-menugroup">
            <button class="ui-topbar-menu" type="button">File</button>
            <div class="ui-dropdown ui-panel" role="menu">
              <button class="ui-menu-item" type="button" data-ui-action="file.import">Import</button>
              <button class="ui-menu-item" type="button" data-ui-action="file.export">Export</button>
            </div>
          </div>
          <div class="ui-menugroup">
            <button class="ui-topbar-menu" type="button">Edit</button>
            <div class="ui-dropdown ui-panel" role="menu">
              <button class="ui-menu-item" type="button" data-ui-action="edit.undo">Undo</button>
              <button class="ui-menu-item" type="button" data-ui-action="edit.redo">Redo</button>
              <div class="ui-menu-sep"></div>
              <button class="ui-menu-item" type="button" data-ui-action="add.box">Add Box</button>
              <button class="ui-menu-item" type="button" data-ui-action="add.cylinder">Add Cylinder</button>
              <button class="ui-menu-item" type="button" data-ui-action="add.sphere">Add Sphere</button>
            </div>
          </div>
          <div class="ui-menugroup">
            <button class="ui-topbar-menu" type="button">View</button>
            <div class="ui-dropdown ui-panel" role="menu">
              <button class="ui-menu-item ui-menu-toggle" type="button" aria-pressed="false" data-ui-toggle="view.grid">Grid</button>
              <button class="ui-menu-item ui-menu-toggle" type="button" aria-pressed="false" data-ui-toggle="view.axis">Axis</button>
            </div>
          </div>
          <div class="ui-menugroup">
            <button class="ui-topbar-menu" type="button">Editor</button>
            <div class="ui-dropdown ui-panel" role="menu">
              <button class="ui-menu-item ui-menu-toggle" type="button" aria-pressed="false" data-ui-toggle="editor.snapToGrid">Snap to Grid</button>
              <div class="ui-menu-row">
                <div class="ui-menu-label">Grid Size</div>
                <input class="ui-menu-input" type="number" min="0.01" step="0.01" value="1" data-ui-input="editor.gridSize" />
              </div>
            </div>
          </div>
          <div class="ui-menugroup">
            <button class="ui-topbar-menu" type="button">Help</button>
            <div class="ui-dropdown ui-panel" role="menu">
              <button class="ui-menu-item" type="button" data-ui-action="help.about">How to use</button>
            </div>
          </div>
        </div>
        <div>
          <button class="ui-icon-btn" type="button" aria-label="Settings" id="btn-settings">
            <i data-lucide="settings"></i>
          </button>
        </div>
      </div>
      <div class="ui-help-backdrop" id="help" data-open="false" role="dialog" aria-label="Help">
        <div class="ui-help-card ui-panel" role="document">
          <div class="ui-help-header">
            <div class="ui-help-title">Help</div>
          </div>
          <div class="ui-help-body" id="help-body">
            <div style="display:flex;flex-direction:column;gap:14px">
              <div>
                <div style="font-size:12px;font-weight:600;margin-bottom:6px">Editor</div>
                <div style="font-size:12px;opacity:.85;line-height:1.55">
                   Use the Topbar for File/Edit/View/Editor actions, the Sidebar for tools and quick-add, and the Inspector to edit the selected objectâ€™s transform.
                </div>
              </div>
              <div>
                <div style="font-size:12px;font-weight:600;margin-bottom:6px">Shortcuts</div>
                <div style="font-size:12px;opacity:.85;line-height:1.55;display:flex;flex-direction:column;gap:6px">
                  <div><span style="opacity:.9">Ctrl/Cmd + Z</span> Undo</div>
                  <div><span style="opacity:.9">Ctrl/Cmd + Shift + Z</span> Redo</div>
                  <div><span style="opacity:.9">Ctrl/Cmd + Y</span> Redo</div>
                  <div><span style="opacity:.9">Shift + M</span>  Move/Translate Mode</div>
                  <div><span style="opacity:.9">Shift + S</span>  Scale Mode</div>
                  <div><span style="opacity:.9">Shift + R</span>  Rotate Mode</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="ui-sidebar ui-panel">
        <button class="ui-tool" type="button" data-tip="Select" data-tool="select"><i data-lucide="mouse-pointer-2"></i></button>
        <button class="ui-tool" type="button" data-tip="Move" data-tool="move"><i data-lucide="move"></i></button>
        <button class="ui-tool" type="button" data-tip="Rotate" data-tool="rotate"><i data-lucide="rotate-cw"></i></button>
        <button class="ui-tool" type="button" data-tip="Scale" data-tool="scale"><i data-lucide="scale"></i></button>
        <div class="ui-spacer"></div>
        <button class="ui-tool" type="button" data-tip="Add Box" data-tool="add.box"><i data-lucide="box"></i></button>
        <button class="ui-tool" type="button" data-tip="Add Cylinder" data-tool="add.cylinder"><i data-lucide="database"></i></button>
        <button class="ui-tool" type="button" data-tip="Add Sphere" data-tool="add.sphere"><i data-lucide="circle"></i></button>
        <button class="ui-tool" type="button" data-tip="Delete Selected" data-tool="delete"><i data-lucide="trash-2"></i></button>
      </div>

      <div class="ui-inspector ui-panel" id="inspector" hidden>
        <div class="ui-inspector-header">
          <div class="ui-title" id="inspector-name">Selected</div>
          <button class="ui-del" id="inspector-delete" type="button">Delete</button>
        </div>

        <details open>
          <summary>Position</summary>
          <div class="ui-body">
            <div class="ui-row" data-bind="position" data-axis="x"><div class="ui-axis">X</div><input type="range" min="-10" max="10" step="0.01" value="0"><input type="number" min="-10" max="10" step="0.01" value="0"></div>
            <div class="ui-row" data-bind="position" data-axis="y"><div class="ui-axis">Y</div><input type="range" min="-10" max="10" step="0.01" value="0"><input type="number" min="-10" max="10" step="0.01" value="0"></div>
            <div class="ui-row" data-bind="position" data-axis="z"><div class="ui-axis">Z</div><input type="range" min="-10" max="10" step="0.01" value="0"><input type="number" min="-10" max="10" step="0.01" value="0"></div>
          </div>
        </details>
        <details>
          <summary>Rotation</summary>
          <div class="ui-body">
            <div class="ui-row" data-bind="rotation" data-axis="x"><div class="ui-axis">X</div><input type="range" min="-180" max="180" step="0.1" value="0"><input type="number" min="-180" max="180" step="0.1" value="0"></div>
            <div class="ui-row" data-bind="rotation" data-axis="y"><div class="ui-axis">Y</div><input type="range" min="-180" max="180" step="0.1" value="0"><input type="number" min="-180" max="180" step="0.1" value="0"></div>
            <div class="ui-row" data-bind="rotation" data-axis="z"><div class="ui-axis">Z</div><input type="range" min="-180" max="180" step="0.1" value="0"><input type="number" min="-180" max="180" step="0.1" value="0"></div>
          </div>
        </details>
        <details>
          <summary>Scale</summary>
          <div class="ui-body">
            <div class="ui-row" data-bind="scale" data-axis="x"><div class="ui-axis">X</div><input type="range" min="0" max="5" step="0.01" value="1"><input type="number" min="0" max="5" step="0.01" value="1"></div>
            <div class="ui-row" data-bind="scale" data-axis="y"><div class="ui-axis">Y</div><input type="range" min="0" max="5" step="0.01" value="1"><input type="number" min="0" max="5" step="0.01" value="1"></div>
            <div class="ui-row" data-bind="scale" data-axis="z"><div class="ui-axis">Z</div><input type="range" min="0" max="5" step="0.01" value="1"><input type="number" min="0" max="5" step="0.01" value="1"></div>
          </div>
        </details>
      </div>
    </div>
    <script type="module" src="/src/main.ts"></script>
    <script type="module">
      const ui = document.getElementById("ui");
      const help = document.getElementById("help");
      const inspector = document.getElementById("inspector");
      const nameEl = document.getElementById("inspector-name");
      const rows = [...inspector.querySelectorAll("[data-bind]")];
      const toggles = {
        grid: ui.querySelector('[data-ui-toggle="view.grid"]'),
        axis: ui.querySelector('[data-ui-toggle="view.axis"]'),
        snap: ui.querySelector('[data-ui-toggle="editor.snapToGrid"]'),
        gridSize: ui.querySelector('[data-ui-input="editor.gridSize"]')
      };
      const tools = [...ui.querySelectorAll("[data-tool]")];

      const createIcons = () => {
        const lucide = window.lucide;
        if (!lucide?.createIcons) return;
        lucide.createIcons();
      };
      createIcons();

      const actions = () => window.EditorActions;

      const setPressed = (el, on) => {
        if (!el) return;
        el.setAttribute("aria-pressed", on ? "true" : "false");
      };

      const syncRow = (row, val) => {
        const r = row.querySelector('input[type="range"]');
        const n = row.querySelector('input[type="number"]');
        r.value = String(val);
        n.value = String(val);
      };

      const applyFromUI = (bind) => {
        const get = (axis) => {
          const row = rows.find((x) => x.getAttribute("data-bind") === bind && x.getAttribute("data-axis") === axis);
          const n = row.querySelector('input[type="number"]');
          return Number(n.value) || 0;
        };
        const x = get("x"), y = get("y"), z = get("z");
        if (bind === "position") actions()?.moveSelected(x, y, z);
        if (bind === "rotation") actions()?.rotateSelectedDeg(x, y, z);
        if (bind === "scale") actions()?.scaleSelected(x, y, z);
      };

      rows.forEach((row) => {
        const bind = row.getAttribute("data-bind");
        const r = row.querySelector('input[type="range"]');
        const n = row.querySelector('input[type="number"]');
        const apply = (raw) => {
          const min = Number(r.min), max = Number(r.max);
          const v = Math.min(max, Math.max(min, Number(raw) || 0));
          syncRow(row, v);
          applyFromUI(bind);
        };
        r.addEventListener("input", (e) => apply(e.target.value));
        n.addEventListener("change", (e) => apply(e.target.value));
      });

      ui.addEventListener("click", (e) => {
        const t = e.target instanceof Element ? e.target : null;
        if (!t) return;
        const tool = t.closest("[data-tool]");
        if (tool) {
          const name = tool.getAttribute("data-tool");
          if (name === "move") actions()?.setMode("translate");
          if (name === "rotate") actions()?.setMode("rotate");
          if (name === "scale") actions()?.setMode("scale");
          if (name === "add.box") actions()?.addBox();
          if (name === "add.cylinder") actions()?.addCylinder();
          if (name === "add.sphere") actions()?.addSphere();
          if (name === "delete") actions()?.deleteSelected();
          return;
        }
        const act = t.closest("[data-ui-action]");
        if (act) {
          const id = act.getAttribute("data-ui-action");
          if (id === "file.export") {
            const json = actions()?.exportJson?.();
            if (typeof json === "string") {
              const blob = new Blob([json], { type: "application/json" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "scene.json";
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            }
            return;
          }
          if (id === "file.import") {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "application/json,.json";
            input.onchange = async () => {
              const file = input.files?.[0];
              if (!file) return;
              const txt = await file.text();
              await actions()?.importJson?.(txt);
            };
            input.click();
            return;
          }
          if (id === "help.about") {
            help.setAttribute("data-open","true");
            return;
          }
          if (id === "edit.undo") actions()?.undo?.();
          if (id === "edit.redo") actions()?.redo?.();
          if (id === "add.box") actions()?.addBox();
          if (id === "add.cylinder") actions()?.addCylinder();
          if (id === "add.sphere") actions()?.addSphere();
          return;
        }
        const tog = t.closest("[data-ui-toggle]");
        if (tog) {
          const key = tog.getAttribute("data-ui-toggle");
          const on = tog.getAttribute("aria-pressed") !== "true";
          setPressed(tog, on);
          if (key === "view.grid") actions()?.showGrid(on);
          if (key === "view.axis") actions()?.showAxis(on);
          if (key === "editor.snapToGrid") actions()?.setSnapToGrid(on);
          return;
        }
        if (t.closest("#inspector-delete")) actions()?.deleteSelected();
        if (t.closest("#help-close")) help.setAttribute("data-open","false");
      });

      toggles.gridSize.addEventListener("change", () => actions()?.setGridSize(Number(toggles.gridSize.value) || 1));

      const radToDeg = (r) => (r * 180) / Math.PI;
      const isEditingInspector = () => inspector.contains(document.activeElement);

      let last = null;
      const tick = () => {
        const a = actions();
        const state = a?.getState?.() || null;
        if (!state) return requestAnimationFrame(tick);

        setPressed(toggles.grid, !!state.grid);
        setPressed(toggles.axis, !!state.axis);
        setPressed(toggles.snap, !!state.snap);
        if (!toggles.gridSize.matches(":focus")) toggles.gridSize.value = String(state.gridSize ?? 1);

        tools.forEach((b) => b.classList.remove("is-active"));
        const mode = state.mode;
        const activeTool = mode === "translate" ? "move" : mode;
        const btn = tools.find((x) => x.getAttribute("data-tool") === activeTool);
        if (btn) btn.classList.add("is-active");

        const sel = state.selected;
        const id = sel?.id || null;
        if (id !== last) {
          last = id;
          inspector.hidden = !sel;
        }
        if (sel && !isEditingInspector()) {
          nameEl.textContent = String(sel.name || "Object");
          rows.forEach((row) => {
            const bind = row.getAttribute("data-bind");
            const axis = row.getAttribute("data-axis");
            let v = 0;
            if (bind === "position") v = sel.position[{ x: 0, y: 1, z: 2 }[axis]] ?? 0;
            if (bind === "rotation") v = radToDeg(sel.rotation[{ x: 0, y: 1, z: 2 }[axis]] ?? 0);
            if (bind === "scale") v = sel.scale[{ x: 0, y: 1, z: 2 }[axis]] ?? 1;
            syncRow(row, v);
          });
        }
        requestAnimationFrame(tick);
      };

      const start = () => requestAnimationFrame(tick);
      window.addEventListener("editor-ready", start, { once: true });
      if (actions()?.getState) start();

      ui.addEventListener("wheel", (e) => {
        if (e.target.closest(".ui-topbar") || e.target.closest(".ui-dropdown") || e.target.closest(".ui-inspector")) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, { passive: false });

      window.addEventListener("pointerdown", (e) => {
        if (help.getAttribute("data-open") !== "true") return;
        if (e.target.closest(".ui-help-card")) return;
        help.setAttribute("data-open", "false");
      });

      const isTypingTarget = (el) => {
        if (!el) return false;
        const tag = el.tagName;
        if (tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT") return true;
        if (el.isContentEditable) return true;
        return false;
      };

      window.addEventListener("keydown", (e) => {
        if (isTypingTarget(e.target)) return;
        const a = actions();
        if (!a) return;
        const mod = e.ctrlKey || e.metaKey||e.shiftKey;
        if (!mod) return;
        const k = String(e.key || "").toLowerCase();
        if (k === "z" && !e.shiftKey) {
          e.preventDefault();
          a.undo?.();
          return;
        }
        if (k === "y" || (k === "z" && e.shiftKey)) {
          e.preventDefault();
          a.redo?.();
          return;
        }
        if(k==="m" && e.shiftKey) {
          e.preventDefault()
          a.setMode("translate")
          return
        }
          if(k==="r" && e.shiftKey) {
          e.preventDefault()
          a.setMode("rotate")
          return
        }
      if(k==="s" && e.shiftKey) {
          e.preventDefault()
          a.setMode("scale")
          return
        }
      });
    </script>
  </body>
</html>
